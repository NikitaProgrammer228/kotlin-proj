# Двойная интеграция ускорения: техническое объяснение

## Что такое двойная интеграция?

**Двойная интеграция** — это математический метод получения **пути (смещения)** из **ускорения**:

```
Ускорение (a) → [интеграция] → Скорость (v) → [интеграция] → Путь (s)
```

**Формулы MicroSwing:**
```
v[i] = v[i-1] + a[i] × Δt
s[i] = s[i-1] + v[i] × Δt
где Δt = 1/50 = 0.02 сек
```

Это **стандартный метод** в постураметрии и стабилометрии.

---

## Почему WT901 не справляется?

### 1. **Проблема гравитации**

Акселерометр измеряет **сумму**:
- **Динамическое ускорение** (от движения платформы) ← это нам нужно
- **Гравитационное ускорение** (1g = 9.8 м/с²) ← это нужно вычесть

**Проблема:** При наклоне датчика гравитация проецируется на оси X и Y:
- Наклон на 1° → проекция ≈ 0.17g
- Наклон на 5° → проекция ≈ 0.87g

Чтобы вычесть гравитацию, нужно:
- Точные углы наклона (roll, pitch)
- Правильная математическая модель
- Калибровка для каждого положения

**WT901:** Углы есть, но компенсация работает неточно из-за:
- Дрейфа гироскопа
- Неточности акселерометра (±0.01g)
- Влияния температуры

### 2. **Накопление ошибок**

Даже **маленькая ошибка** 0.01g накапливается при интегрировании:

```
За 1 секунду (50 сэмплов):
Ошибка скорости = 0.01g × 50 × 0.02с = 0.01 м/с
Ошибка пути = 0.01 м/с × 1с = 0.01 м = 10 мм

За 10 секунд:
Ошибка пути ≈ 100-200 мм (график "уплывает")
```

**Результат:** График дрейфует даже когда платформа неподвижна.

### 3. **Bias дрейф**

**Bias** — это постоянное смещение акселерометра (ошибка нуля).

**Проблема:**
- Bias меняется с температурой
- Bias меняется при вибрациях
- Калибровка в начале не помогает, если датчик потом наклонится

**WT901:** Bias нестабилен, особенно при изменении ориентации.

---

## Какие модули могут делать двойную интеграцию?

### ✅ **Профессиональные IMU (Inertial Measurement Unit):**

1. **Xsens MTi-1/MTi-3** (≈$500-1000)
   - Встроенный sensor fusion (Kalman filter)
   - Компенсация температуры
   - Точность: ±0.01g, дрейф < 0.1°/час

2. **VectorNav VN-100** (≈$300-500)
   - AHRS (Attitude and Heading Reference System)
   - Высокая точность
   - Стабильная компенсация гравитации

3. **Bosch BMI160 + BMM150** (≈$10-20, но нужна калибровка)
   - Бюджетный вариант
   - Требует сложной калибровки и sensor fusion в ПО

### ⚠️ **Промежуточный вариант: BWT901CL** (от WitMotion)

**Характеристики** ([источник](https://www.wit-motion.com/BLE/50.html)):
- ✅ **Встроенный Kalman filter** для sensor fusion
- ✅ **Attitude solver** внутри модуля (решатель ориентации)
- ✅ Точность углов: **0.2°**
- ✅ RMS шум акселерометра: **0.75~1 mg-rms** (≈0.00075~0.001g) — **очень хорошо!**
- ✅ Статический дрейф нуля: **±20~40 mg** (≈±0.02~0.04g)
- ✅ Bias stability гироскопа: **≤10°/час** — **приемлемо!**
- ✅ 9-осевой алгоритм (акселерометр + гироскоп + магнитометр)
- ✅ Частота вывода: **0.2-200 Гц** (можно настроить 50 Гц)

**Оценка для двойной интеграции:**
- ✅ **Значительно лучше** чем обычный WT901
- ✅ Встроенный sensor fusion **может помочь** с компенсацией гравитации
- ⚠️ Всё ещё не профессиональный IMU (дрейф может быть)
- ⚠️ Нужно **протестировать** на практике

**Вывод:** BWT901CL — **промежуточный вариант**. Стоит попробовать двойную интеграцию, но гарантий нет. Если дрейф всё равно будет, можно вернуться к подходу через углы.

### ❌ **Бюджетные MEMS-акселерометры (WT901, MPU6050):**
- Не имеют встроенного sensor fusion
- Bias дрейфует
- Нет компенсации температуры
- **Не подходят** для точной двойной интеграции

---

## Что мы предлагаем вместо двойной интеграции?

### ✅ **Подход через углы (текущая реализация)**

**Принцип:**
- WT901 имеет **встроенный гироскоп** и вычисляет углы Эйлера (roll, pitch)
- Углы **стабильнее** чем интегрированное ускорение
- Переводим угол наклона → виртуальное смещение

**Преимущества:**
- ✅ Работает стабильно без дрейфа
- ✅ Не требует сложной калибровки
- ✅ Даёт результаты, **визуально похожие** на MicroSwing
- ✅ Использует встроенные возможности датчика

**Недостатки:**
- ⚠️ Это не "настоящее" смещение, а виртуальное (угол × коэффициент)
- ⚠️ Коэффициент нужно подбирать эмпирически

**Результат:** Графики выглядят правильно, метрики (стабильность, частота) считаются корректно.

---

## Какие есть опции?

### **Вариант 1: Оставить текущий подход (рекомендуется)**
- ✅ Работает стабильно
- ✅ Не требует замены датчика
- ✅ Результаты визуально соответствуют MicroSwing
- ⚠️ Это не "настоящая" двойная интеграция, но **функционально эквивалентно**

### **Вариант 2: Заменить датчик на профессиональный IMU**
- ✅ Настоящая двойная интеграция
- ✅ Высокая точность
- ❌ Стоимость: +$300-1000
- ❌ Нужна переработка кода
- ❌ Возможны проблемы с Bluetooth на Android

### **Вариант 3: Заменить на BWT901CL (промежуточный вариант)**
- ✅ Встроенный Kalman filter и attitude solver
- ✅ Низкий шум акселерометра (0.75~1 mg-rms)
- ✅ Bias stability гироскопа ≤10°/час
- ✅ Стоимость: ~$30-50 (дешевле профессиональных IMU)
- ⚠️ Нужно протестировать — возможно дрейф всё равно будет
- ⚠️ Нужна переработка кода для двойной интеграции
- ⚠️ Если не сработает — можно вернуться к подходу через углы

**Рекомендация:** Если есть возможность, стоит **протестировать** BWT901CL с двойной интеграцией. Если дрейф будет приемлемым (< 20-30 мм за 10 сек), это будет лучше чем подход через углы.

### **Вариант 4: Улучшить компенсацию гравитации в текущем коде**
- ✅ Можно попробовать более точную модель компенсации
- ⚠️ Вероятно всё равно будет дрейф
- ⚠️ Требует много тестирования

---

## Вывод

**Двойная интеграция ускорения** — это правильный метод, но он требует:
1. Высокоточный акселерометр (±0.001g)
2. Стабильный гироскоп (дрейф < 0.1°/час)
3. Sensor fusion алгоритм (Kalman filter)
4. Компенсацию температуры

**WT901** — это бюджетный MEMS-датчик, который **не предназначен** для точной двойной интеграции.

**BWT901CL** — промежуточный вариант с встроенным Kalman filter. **Может работать** с двойной интеграцией, но нужно протестировать.

**Наш подход через углы** даёт **функционально эквивалентный** результат без дрейфа и сложной калибровки.

---

## Рекомендация

**Оставить текущий подход** (углы → смещение), так как:
- Результаты визуально соответствуют MicroSwing
- Метрики (стабильность, частота колебаний) считаются корректно
- Нет дрейфа и проблем с калибровкой
- Не требует дополнительных затрат

Если в будущем понадобится **максимальная точность**, можно рассмотреть замену датчика на профессиональный IMU.

